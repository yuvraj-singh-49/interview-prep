# KMS & Encryption

## KMS Overview

```
KMS = Key Management Service

┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   KMS Key Hierarchy:                                                     │
│                                                                          │
│   ┌─────────────────────────────────────────────────────────────────┐   │
│   │                    Customer Master Key (CMK)                     │   │
│   │                    (Never leaves KMS)                            │   │
│   └──────────────────────────────┬──────────────────────────────────┘   │
│                                  │                                       │
│                         Generate Data Key                               │
│                                  │                                       │
│                    ┌─────────────┴─────────────┐                        │
│                    │                           │                        │
│              ┌─────┴─────┐               ┌─────┴─────┐                  │
│              │ Plaintext │               │ Encrypted │                  │
│              │ Data Key  │               │ Data Key  │                  │
│              └─────┬─────┘               └─────┬─────┘                  │
│                    │                           │                        │
│              ┌─────┴─────┐               ┌─────┴─────┐                  │
│              │ Encrypt   │               │  Store    │                  │
│              │ Data      │               │ with Data │                  │
│              └───────────┘               └───────────┘                  │
│                                                                          │
│   This is "Envelope Encryption"                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Key Types

### CMK Types

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Key Type              │ Management      │ Use Case                      │
├───────────────────────┼─────────────────┼───────────────────────────────┤
│ AWS Managed           │ AWS creates &   │ Service default encryption    │
│ (aws/service)         │ rotates yearly  │ (aws/s3, aws/ebs, aws/rds)   │
├───────────────────────┼─────────────────┼───────────────────────────────┤
│ Customer Managed      │ You create &    │ Custom policies, audit,       │
│ (CMK)                 │ manage          │ cross-account sharing         │
├───────────────────────┼─────────────────┼───────────────────────────────┤
│ AWS Owned             │ AWS owns &      │ AWS service internal          │
│                       │ manages         │ (not visible to you)          │
└───────────────────────┴─────────────────┴───────────────────────────────┘

Key Material Origin:
- KMS: Generated by KMS (default)
- External: Import your own key material
- Custom Key Store: CloudHSM-backed keys
```

### Key Policies

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "Enable IAM policies",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:root"},
      "Action": "kms:*",
      "Resource": "*"
    },
    {
      "Sid": "Allow key administrators",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:role/KeyAdmin"},
      "Action": [
        "kms:Create*",
        "kms:Describe*",
        "kms:Enable*",
        "kms:List*",
        "kms:Put*",
        "kms:Update*",
        "kms:Revoke*",
        "kms:Disable*",
        "kms:Get*",
        "kms:Delete*",
        "kms:ScheduleKeyDeletion",
        "kms:CancelKeyDeletion"
      ],
      "Resource": "*"
    },
    {
      "Sid": "Allow use of the key",
      "Effect": "Allow",
      "Principal": {"AWS": "arn:aws:iam::123456789012:role/AppRole"},
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "*"
    }
  ]
}
```

---

## Envelope Encryption

```
Why Envelope Encryption?
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   Problem: Encrypting large data with CMK                               │
│   - Network overhead sending data to KMS                                │
│   - KMS has request size limits (4KB)                                   │
│                                                                          │
│   Solution: Envelope Encryption                                          │
│   1. Generate data key with CMK                                         │
│   2. Encrypt data locally with data key                                 │
│   3. Store encrypted data key with data                                 │
│   4. Delete plaintext data key                                          │
│                                                                          │
│   Decryption:                                                            │
│   1. Get encrypted data key from storage                                │
│   2. Decrypt data key with CMK                                          │
│   3. Decrypt data with plaintext data key                               │
│   4. Delete plaintext data key                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

// AWS SDK handles this automatically
// S3, EBS, RDS all use envelope encryption internally
```

### Implementing Envelope Encryption

```javascript
const { KMSClient, GenerateDataKeyCommand, DecryptCommand } = require('@aws-sdk/client-kms');
const crypto = require('crypto');

const kms = new KMSClient();

// Encrypt data
async function encryptData(plaintext, keyId) {
  // 1. Generate data key
  const { Plaintext, CiphertextBlob } = await kms.send(
    new GenerateDataKeyCommand({
      KeyId: keyId,
      KeySpec: 'AES_256'
    })
  );

  // 2. Encrypt data with plaintext data key
  const cipher = crypto.createCipheriv('aes-256-gcm', Plaintext, iv);
  const encrypted = Buffer.concat([cipher.update(plaintext), cipher.final()]);
  const tag = cipher.getAuthTag();

  // 3. Return encrypted data + encrypted data key
  // (Plaintext data key is in memory only, discard after use)
  return {
    encryptedData: encrypted,
    encryptedDataKey: CiphertextBlob,
    iv: iv,
    tag: tag
  };
}

// Decrypt data
async function decryptData(encryptedData, encryptedDataKey, iv, tag, keyId) {
  // 1. Decrypt the data key
  const { Plaintext } = await kms.send(
    new DecryptCommand({
      CiphertextBlob: encryptedDataKey,
      KeyId: keyId
    })
  );

  // 2. Decrypt data with plaintext data key
  const decipher = crypto.createDecipheriv('aes-256-gcm', Plaintext, iv);
  decipher.setAuthTag(tag);
  return Buffer.concat([decipher.update(encryptedData), decipher.final()]);
}
```

---

## Key Rotation

```
Automatic Key Rotation:
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   ┌─────────────┐    ┌─────────────┐    ┌─────────────┐                │
│   │ Key v1      │    │ Key v2      │    │ Key v3      │                │
│   │ (2022)      │    │ (2023)      │    │ (2024)      │                │
│   └─────────────┘    └─────────────┘    └─────────────┘                │
│         │                  │                  │                         │
│         └──────────────────┴──────────────────┘                         │
│                            │                                            │
│                      Same Key ID                                        │
│                                                                          │
│   - New key material yearly (CMK only)                                  │
│   - Old versions kept for decryption                                    │
│   - Encryption uses latest version                                      │
│   - Transparent to applications                                         │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘

Enable Rotation:
aws kms enable-key-rotation --key-id <key-id>

Manual Rotation:
- Create new key
- Update applications to use new key ID
- Keep old key for existing data decryption
```

---

## Multi-Region Keys

```
Multi-Region Keys:
┌─────────────────────────────────────────────────────────────────────────┐
│                                                                          │
│   US-EAST-1                         EU-WEST-1                           │
│   ┌───────────────────┐            ┌───────────────────┐               │
│   │ Primary Key       │◀──────────▶│ Replica Key       │               │
│   │ mrk-xxx           │   (sync)   │ mrk-xxx           │               │
│   └───────────────────┘            └───────────────────┘               │
│                                                                          │
│   Features:                                                              │
│   - Same key ID across regions                                          │
│   - Encrypt in one region, decrypt in another                          │
│   - No re-encryption needed for DR                                      │
│   - Independent key policies per region                                 │
│                                                                          │
│   Use Cases:                                                             │
│   - Global databases (DynamoDB Global Tables)                          │
│   - Cross-region DR                                                     │
│   - Multi-region applications                                          │
│                                                                          │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## Encryption in AWS Services

```
Service Encryption Options:
┌─────────────────────────────────────────────────────────────────────────┐
│ Service     │ At Rest                    │ In Transit                   │
├─────────────┼────────────────────────────┼──────────────────────────────┤
│ S3          │ SSE-S3, SSE-KMS, SSE-C     │ HTTPS                       │
│ EBS         │ KMS (default or custom)    │ EC2 ↔ EBS encrypted         │
│ RDS         │ KMS encryption             │ SSL/TLS                      │
│ DynamoDB    │ AWS managed or CMK         │ HTTPS                       │
│ Lambda      │ Environment vars with KMS  │ HTTPS                       │
│ Secrets Mgr │ KMS encryption             │ HTTPS                       │
│ EFS         │ KMS encryption             │ TLS mount option            │
│ SNS/SQS     │ SSE with CMK               │ HTTPS                       │
└─────────────┴────────────────────────────┴──────────────────────────────┘

Default Encryption:
- S3: Server-side encryption enabled by default (2023)
- EBS: Account-level default encryption setting
- RDS: Encryption at creation (cannot enable later)
```

---

## Secrets Manager vs Parameter Store

```
┌─────────────────────────────────────────────────────────────────────────┐
│ Feature              │ Secrets Manager        │ Parameter Store         │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Primary Use          │ Secrets (passwords,    │ Configuration values,   │
│                      │ API keys, credentials) │ flags, secrets          │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Auto Rotation        │ Yes (built-in)         │ No                      │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Cross-Account        │ Yes                    │ Yes                     │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Pricing              │ $0.40/secret/month     │ Standard: Free          │
│                      │ $0.05/10K API calls    │ Advanced: $0.05/param   │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Max Size             │ 64 KB                  │ 8 KB (standard)         │
│                      │                        │ 64 KB (advanced)        │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Versioning           │ Yes                    │ Yes                     │
├──────────────────────┼────────────────────────┼─────────────────────────┤
│ Integration          │ RDS, Redshift native   │ Broader AWS integration │
└──────────────────────┴────────────────────────┴─────────────────────────┘

Recommendation:
- Secrets Manager: Database credentials, API keys (with rotation)
- Parameter Store: App configuration, feature flags, small secrets
```

### Secrets Manager Rotation

```javascript
// Automatic rotation for RDS
{
  "engine": "mysql",
  "host": "mydb.xxx.us-east-1.rds.amazonaws.com",
  "username": "admin",
  "password": "current-password"
}

// Lambda rotation function handles:
// 1. Create new password version (AWSPENDING)
// 2. Set password in RDS
// 3. Test new credentials
// 4. Mark new version as AWSCURRENT

// Application retrieval
const secret = await secretsManager.getSecretValue({
  SecretId: 'mydb-credentials'
});
const credentials = JSON.parse(secret.SecretString);
```

---

## Interview Discussion Points

### How do you secure sensitive data in AWS?

```
Defense in Depth:

1. Encryption at Rest
   - KMS for all data stores
   - Customer-managed keys for control
   - Enable default encryption

2. Encryption in Transit
   - TLS everywhere
   - Certificate management (ACM)
   - Enforce HTTPS (bucket policies, ALB)

3. Secrets Management
   - Secrets Manager for credentials
   - Auto-rotation enabled
   - Never hardcode secrets

4. Access Control
   - IAM least privilege
   - Resource policies (S3, KMS)
   - VPC endpoints for AWS services

5. Audit Trail
   - CloudTrail for API calls
   - KMS key usage logging
   - Secrets Manager access logs
```

### How do you design for compliance (HIPAA, PCI, etc.)?

```
Compliance Framework:

1. Data Classification
   - Identify sensitive data
   - Tag resources appropriately
   - Restrict access by classification

2. Encryption Requirements
   - Customer-managed KMS keys
   - Key rotation policies
   - Multi-region for availability

3. Access Control
   - MFA for all users
   - No long-term credentials
   - Regular access reviews

4. Audit & Monitoring
   - CloudTrail (all regions)
   - Config rules for compliance
   - GuardDuty for threats
   - Security Hub for unified view

5. Network Security
   - Private subnets for sensitive data
   - VPC endpoints
   - WAF for public endpoints

6. Incident Response
   - Documented procedures
   - Automated alerting
   - Regular testing
```

### How do you handle key compromise?

```
Key Compromise Response:

1. Immediate Actions
   - Disable compromised key
   - Identify affected data
   - Notify security team

2. Assess Impact
   - CloudTrail: Key usage history
   - Identify all encrypted resources
   - Determine data exposure scope

3. Remediation
   - Create new key
   - Re-encrypt affected data
   - Update applications

4. Recovery
   - Decrypt with old key, re-encrypt with new
   - Or restore from backup (pre-compromise)

5. Prevention
   - Key policies (least privilege)
   - Separate keys per environment
   - Regular key rotation
   - Monitor for unusual usage

// Re-encryption pattern
async function reEncrypt(bucketName, keyId) {
  const objects = await s3.listObjects({ Bucket: bucketName });

  for (const obj of objects.Contents) {
    await s3.copyObject({
      Bucket: bucketName,
      CopySource: `${bucketName}/${obj.Key}`,
      Key: obj.Key,
      ServerSideEncryption: 'aws:kms',
      SSEKMSKeyId: keyId
    });
  }
}
```
